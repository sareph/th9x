#summary Anleitung zum Umbau und flashen der neuen Firmware

= Inhalt =

<wiki:toc max_depth="1" />

= Ihr braucht =

 * Den Sender (Turnigy/Eurgle/Imax/FlySky)
 * Lötkolben
 * AVR Programmer
 * Computer mit Linux/Mac OS/Windows



= Welchen Programmer? =

Prinzipiell eignet sich jeder AVR kompatible ISP (AVR ISP, In-System Programmer). Persöhnlich kann ich nur AVRdude kompatible programmer empfehlen! Warum?

AVRdude ist Open Source, verfügbar für Windows, Linux&Mac, unterstützt COM/LPT&USB,
ist breit unterstützt und wird aktiv weiterentwickelt.

Programmer gibt es für die serielle, parallele und USB Schnittstelle. 
Vorteile der Seriell- und Parallelport-Programmer sind nicht notwendige Treiber,
Nachteile sind die Verfügbarkeit dieser Schnittstellen an neuen Rechnern und die
manchmal notwendige externe Stromversorgung der ISP’s.

USB ISP’s versorgen sich aus der USB Schnittstelle und können das Target (i.e. den Sender)
gleich mit Strom mitversorgen, es muss aber darauf geachtet werden das für Windows
notwendige Treiber bereitgestellt sind.

Eine Liste der von AVRdude unterstützen Programmer findet sich [http://www.nongnu.org/avrdude/user-manual/avrdude_4.html hier]. Diese können von eBay oder den gängigen Elektronikversandhäusern zwischen 5 und 30Euro erworben werden.
Von Forenmitgliedern benutzte programmer sind nachfolgend aufgelistet.

|| || USB || LPT ||
|| erfolgreich || [http://www.sparkfun.com/commerce/product_info.php?products_id=9231 Pocket AVR Programmer], AVR ISP MKII, [http://shop.myavr.de/Programmer/mySmartUSB%2520MK2%2520(Programmer%2520und%2520Bridge).htm?sp=article.sp.php&artID=42 MySmartUSB MKII], [http://and-tech.pl/Stk500/AVRProgUSB-v1.3-ang.pdf AVRProgUSB], [http://www.mikrocontroller.net/articles/AVR-ISP-Stick USBTinyISP] || [http://home.arcor.de/dh2iw/shop.html AVR-ISP-Parallelport-Programmer], [http://cgi.ebay.de/AVR-Atmel-ISP-parallel-Programmer-/170491386034?cmd=ViewItem&pt=Bauteile&hash=item27b21418b2#ht_1489wt_889 AVR Atmel ISP parallel Programmer]||
|| problematisch || [http://wiki.ullihome.de/index.php/USBAVR-ISP/de#USB_AVR_Lab_als_Programmier.2FDebugadapter USB-AVRlab] || [http://s-huehn.de/elektronik/avr-prog/avr-prog.htm Primitiv Parallelport programmer] ||

Vermutlich wird ein USB programmer dem LPT pendant bevorzugt. Abgesehen von der Stromversorgung und der Schnittstellenwahl in AVRdude ist das meiste allerdings gleich.




= Verbinden der Th9x mit dem Programmer =

Die Anschlüsse des Programmers müssen mit dem Mikrocontroller im Sender (ATmega64) verbunden werden. Atmel hat als Standard einen 6 oder 10 poligen Anschluss. Mindestens einer von beiden ist auf jedem AVR programmer zu finden. Die Atmel Standardbelegung sieht wie folgt aus:

<img src="http://th9x.googlecode.com/svn/wiki/atmel_6-10pin.png" width=600>



diese müssen wie nachfolgend abgebildet mit dem Sender verbunden werden. Den Turnigy Sender gibt es
in 2 Versionen, abgebildet ist die v1, bei der v2 ist an SCK ein Lötpad (roter Kreis).

<img src="http://th9x.googlecode.com/svn/wiki/turnigy9x_pcb.png" width=600>


Es wird empfohlen dünnes und flexibles Kabel zu benutzen (z.B. die Litze aus einem Netzwerkkabel), da sich ansonsten bei starker Belastung u.U. Leiterbahnen von der Platine lösen könnten. Es ist auch empfehlenswert die Lötstellen mit einer Heißklebepistole zu sichern. Heißkleber ist einfach anwendbar und auch einfach wieder zu entfernen!

Bei den meisten Programmern ist ein Stecker mit Kabel für den 6 Pin Anschluss dabei. Nach erfolgtem Löten überprüfen ob die Verbindung vom Programmerstecker bis hin zu den Pins des Mikrocontroller besteht (siehe Pfeile Pinbelegung Prozessor). Falls nicht, siehe Fehlerquellen.

Parallelport Programmer benötigen oftmals die Stromversorgung durch die Batterie im Sender, daher muss der Vcc pin angeschlossen sein. USB programmer können üblicherweise den Sender mit Strom versorgen (meist muss ein Jumper geschlossen werden). Deshalb muss dabei keine Batterie angeschlossen sein.

Im Fall der Stromversorgung über den USB Programmer kann mit abgenommener Rückseite und nicht angeschlossenem 12pin connector der Sender nun zum Test mit dem Programmer verbunden werden. Bei angeschlossenem Vcc sollte sich der Sender nun anschalten und mit SwitchError melden, da die meisten Schalter über den 12Pin connector ja abgeklemmt sind.



= Einrichten der Software =

Alle `klein` geschriebenen Wörter sind Konsolenbefehle, d.h. in Windows gibt man sie in
Start -> ausführen -> `cmd` ein, in Mac OS öffnet man Anwendungen/Dienstprogramme/Terminal.

 # Für Windows den mitgelieferten Treiber des Programmers installieren, Mac OS und Linux Benutzer benötigen meist keinen Treiber.
 # AVRdude installieren:
  * Windows Benutzer laden sich am besten [http://sourceforge.net/projects/winavr/files/ WinAVR], welches AVRdude beinhaltet.
  * Mac OS Nutzer installieren [http://www.macports.org/install.php MacPorts] (setzt Xcode von der Mac OS installer DVD vorraus). Dann ein Terminal Fenster öffnen und folgenden Befehl eintippen: `sudo port install avrdude` jetzt kann man einen Kaffee trinken und warten bis MacPorts AVRdude und alles was es dazu benötigt installiert.
  * Linux user wissen sicher wie sie an die aktuelle Version von AVRdude herankommen :)
  * Die aktuelle Version von AVRdude ist 5.10
 # Optionale GUI’s (Grafische Benutzeroberflächen) gibt es für AVRdude sowohl für für Windows (z.B. [http://sourceforge.net/projects/avrdude-gui/files/avrdude-gui/avrdude-gui_0.2.0/avrdude-gui_v0.2.0.zip/download avrdude-gui_v0.2.0]), Windows & Mac OS (z.B. [http://avr8-burn-o-mat.aaabbb.de/ AVR Burn-O-Mat], [http://www.vonnieda.org/software/avrfuses AVRFuses]) oder Windows & Linux (z.B. [http://www.soft-land.de/ AVRBurner])
 # Benötigte Parameter für avrdude:
  * `-c xxxx` -> xxxx steht für den verwendeten Programmer, siehe [http://www.nongnu.org/avrdude/user-manual/avrdude_4.html Liste]
  * `-p m64` -> gibt den Target Prozessor an (ATmega64)
  * `-P xxx` -> xxx gibt den Port an, z.B. `com1`, `lpt1`, `usb`, dieser Parameter ist bei USB Programmer meist unnötig
  * `-B  xx` -> xx ist die Periodendauer eines Taktes in uS, höhere Werte bedeuten niedrigere Programmierfrequenz
 # Überprüfen der Verbindung mit AVRdude: bei Eingabe von `avrdude -c xxxx -p m64` sollte, wenn alles richtig gemacht wurde, u.a. folgendes erscheinen:					`avrdude: Device signature = 0x1e9602`
 # Aktuelles binary herunderladen: [http://th9x.googlecode.com/svn/trunk/th9x.bin th9x.bin]


= Sichern und Flashen der Software =

Bevor die neue Software aufgespielt wird empfiehlt es sich die alte zu sichern.
Wer das vergisst findet die Originalsoftware aber auch wieder im Internet .

*ACHTUNG: Beim Flashen des EEPROM gehen alle Modelleinstellungen verloren! Das ist unumgänglich, deshalb alle Einstellungen notieren.*

Folgende Befehle sichern den aktuellen Flash und eeprom Inhalt in **.bin:

	`avrdude -c xxxx -p m64 -U flash:r:backupflash.bin:r`

	`avrdude -c xxxx -p m64 -U eeprom:r:"backupeeprom.bin":r`

Zum aufpielen des neuen flash-Images th9x.bin gibt man folgendes ein:

	`avrdude -c xxxx -p m64 -U flash:w:th9x.bin:a`

Parameter Werte:
 * speichertyp = flash/eeprom
 * operation = r/w (read/write)
 * format = r (raw binary, a=autodetect geht nicht bei read) 

Und das wars auch schon! Der eeprom inhalt muss nicht überschrieben werden, beim ersten Start des Senders wird er neu initialisiert. Falls man eine GUI benutzen möchte: diese tut auch nichts anderes als AVRdude mit diesen Parametern zu starten. Meist sind GUI’s nur bequemer um Ordner bzw. Dateien auszuwählen.

*ACHTUNG: Bei Benutzung von GUI’s auf keinen Fall die Fuses verändern!*

Beim ersten Starten mit der neuen Firmware sollten noch die Knüppel
neu kalibriert werden.



= Fehlersuche =

Es gibt immer etwas was schiefgehen kann, bis jetzt ist aber noch kein Fall bekannt bei dem eine Th9x dauerhaften Schaden genommen hat. Bekannte und gelöste Fehler sind der nachfolgenden Tabelle zu entnehmen. Bei allen anderen unbekannten Fehlern einfach im Forum (siehe Links) melden. Da wird sehr schnell und gut geholfen! Viel Spaß!


|| Meldung || Problem -> Lösung || Bild ||
|| `Setting mode and device parameters.. OK! Entering programming mode.. FAILED! Leaving programming mode.. OK!` || nicht angeschlossenes RST, evtl. durch zerstörte Leiterbahn auf der Platine (nachmessen) -> Leiterbahn vom Lötpad zum Prozessorpin überbrücken || <img src="http://th9x.googlecode.com/svn/wiki/rst_bridge.png" width=200> ||
|| `avrdude: Error: Could not find xxxx device` || ISP am USB Port aus und wieder einstecken; Stromversorgung des USB Ports reicht bei manchen Laptops nicht aus  -> anderen Port ausprobieren oder an Desktop PC versuchen || ||
|| `initialization failed, rc=-1 : AVR device initialized and ready to accept instructions : Device signature = 0x000000 : Yikes! Invalid device signature. : Expected signature for ATMEGA64 is 1E 96 02` || Programmierfrequenz absenken: `-P xx`, xx erhöhen, z.b. 20) ;    				vertauschte Anschlusskabel -> richtig anschliessen; Ail D/R und Thr Cut Schalter auf AUS stellen (v1); Ail D/R und Thr Cut Schalter auf AN stellen (v2); Falls der RST Pegel unter 5V Volt ist (nachmessen) -> Pull Up Widerstand von RST nach Vcc am Eingang des Programmers anschließen (anfangen bei etwa 1kOhm, falls nicht ausreichend bis etwa 200Ohm; gelben 10/46uF Tantal Elektrolytkondensator über RST Pad entfernen || <img src="http://th9x.googlecode.com/svn/wiki/rst_elko.png" width=200> ||



= Links =

 * Review der Turnigy 9ch v2 auf [http://rcmodelreviews.com/turnigy9xv2review.shtml RCModelReviews]    
 * Alles zu AVRdude: http://www.nongnu.org/avrdude/user-manual/    
 * Einführung zu AVR Programmer http://www.mikrocontroller.net/articles/AVR_In_System_Programmer#Einf.C3.BChrung
 * Tutorial zu AVR allgemein: http://www.mikrocontroller.net/articles/AVR-Tutorial    
 * Elektronik Einführung (auch SMD löten): http://www.mikrocontroller.net/articles/Elektronik_Allgemein    
 * Thread auf [http://www.rclineforum.de/forum/thread.php?threadid=239048&sid=&threadview=0&hilight=&hilightuser=&page=50 rclineforum.de]    
 * Thread auf [http://www.rcgroups.com/forums/showthread.php?t=1266162 rcgroups.com],[http://www.rcgroups.com/forums/showthread.php?t=1035575&page=172 rcgroups.com]    
 * Alternative Firmware: http://radioclone.org/; http://sourceforge.net/projects/radioclone/